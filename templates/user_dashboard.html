<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Aegis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/dist/leaflet.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        #userMap { height: 300px; } /* Map needs a defined height */
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 space-y-8">
    
    <div class="w-full max-w-2xl text-center">
        <h1 class="text-3xl font-bold">Welcome, <span class="text-cyan-400">{{ tourist.name }}</span>!</h1>
        <p id="gps-status" class="text-sm text-yellow-400 mt-2 animate-pulse">Initializing GPS...</p>
    </div>

    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-700">
        <div id="userMap" class="rounded-lg z-0 mb-6"></div>
        <h2 class="text-2xl font-bold text-center mb-6 text-cyan-400">Your Information</h2>
        <div class="space-y-4 text-lg">
            </div>
    </div>

    <div class="text-center">
        <button id="panic-button">PANIC</button>
    </div>
    
    <a href="/api/logout">Logout</a>

    <script src="/static/dist/leaflet.js"></script>
    
    <script>
        let userMap;
        let userMarker;

        // Function to initialize the user map
        function initUserMap() {
            userMap = L.map('userMap').setView([28.6139, 77.2090], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(userMap);
            fetchAndDrawZones();
        }

        // Function to get color based on safety score
        function getZoneColor(score) {
            if (score > 80) return 'green';
            if (score > 60) return 'blue';
            if (score > 30) return 'orange';
            return 'red';
        }

        // Fetch safety zones from the new API and draw them
        async function fetchAndDrawZones() {
            const response = await fetch('/api/safety_zones');
            const data = await response.json();
            data.safety_zones.forEach(zone => {
                L.circle([zone.latitude, zone.longitude], {
                    color: getZoneColor(zone.regional_score),
                    fillColor: getZoneColor(zone.regional_score),
                    fillOpacity: 0.2,
                    radius: zone.radius * 1000 // Convert km to meters
                }).addTo(userMap).bindPopup(`<b>${zone.name}</b><br>Regional Score: ${zone.regional_score}`);
            });
        }

        // --- Live GPS Tracking ---
        async function sendLocationUpdate() {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Update the map view and marker
                if (userMap) {
                    const latLng = [lat, lon];
                    userMap.panTo(latLng);
                    if (!userMarker) {
                        userMarker = L.marker(latLng).addTo(userMap).bindPopup("Your current location");
                    } else {
                        userMarker.setLatLng(latLng);
                    }
                }
                
                document.getElementById('gps-status').textContent = `GPS Active | Last update: ${new Date().toLocaleTimeString()}`;
                document.getElementById('gps-status').classList.remove('animate-pulse', 'text-yellow-400');
                document.getElementById('gps-status').classList.add('text-green-400');

                try {
                    await fetch('/api/update_location', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ latitude: lat, longitude: lon })
                    });
                } catch (error) {
                    console.error("Failed to send location update:", error);
                    document.getElementById('gps-status').textContent = 'Error: Could not sync location with server.';
                    document.getElementById('gps-status').classList.add('text-red-500');
                }

            }, () => {
                // Error callback for geolocation
                document.getElementById('gps-status').textContent = 'Error: GPS permission denied or unavailable.';
                document.getElementById('gps-status').classList.remove('animate-pulse', 'text-yellow-400');
                document.getElementById('gps-status').classList.add('text-red-500');
            });
        }
        
        // --- Panic Button ---
        const panicButton = document.getElementById('panic-button');
        panicButton.addEventListener('click', async () => {
            if (confirm("Are you sure you want to send a PANIC alert? This will immediately notify authorities.")) {
                // In a real app, you would have a dedicated /api/panic endpoint
                console.log("PANIC ALERT TRIGGERED!");
                alert("Panic alert has been sent to the authorities.");
            }
        });

        window.onload = () => {
            initUserMap();
            sendLocationUpdate(); 
            setInterval(sendLocationUpdate, 15000); // Update location every 15 seconds
        };
    </script>
</body>
</html>