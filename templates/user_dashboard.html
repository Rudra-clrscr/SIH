
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Aegis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/dist/leaflet.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        #userMap { height: 300px; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 space-y-8">
    
    <div class="w-full max-w-2xl text-center">
        <h1 class="text-3xl font-bold">Welcome, <span class="text-cyan-400">{{ tourist.name }}</span>!</h1>
        <p id="gps-status" class="text-sm text-yellow-400 mt-2 animate-pulse">Initializing GPS...</p>
    </div>

    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-700">
        <div id="userMap" class="rounded-lg z-0 mb-6"></div>
        <h2 class="text-2xl font-bold text-center mb-6 text-cyan-400">Your Information</h2>
        <div class="space-y-3 text-base text-gray-300">
            <div class="flex justify-between">
                <span class="font-semibold text-gray-400">Phone Number:</span>
                <span>{{ tourist.phone }}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-semibold text-gray-400">KYC ID:</span>
                <span>{{ tourist.kyc_id }}</span>
            </div>
            <div class="flex justify-between">
                <span class="font-semibold text-gray-400">Visit Ends On:</span>
                <span>{{ tourist.visit_end_date.strftime('%d-%b-%Y') }}</span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-700">
                <span class="font-semibold text-gray-400">Current Safety Score:</span>
                <span class="text-2xl font-bold {% if tourist.safety_score > 75 %} text-green-400 {% elif tourist.safety_score > 40 %} text-yellow-400 {% else %} text-red-500 {% endif %}">
                    {{ tourist.safety_score }}
                </span>
            </div>
            <div class="pt-2 border-t border-gray-700">
                <span class="font-semibold text-gray-400 text-sm">Blockchain Digital ID:</span>
                <p class="font-mono text-xs text-cyan-400 break-all">{{ tourist.digital_id }}</p>
            </div>
        </div>
    </div>

    <div class="text-center">
        <button id="panic-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-md">PANIC</button>
    </div>
    
    <a href="/api/logout" class="text-gray-400 hover:text-cyan-400 transition duration-300">Logout</a>

    <script src="/static/dist/leaflet.js"></script>
    <script>
        let userMap, userMarker;
        function initUserMap() {
            userMap = L.map('userMap').setView([28.6139, 77.2090], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(userMap);
            fetchAndDrawZones();
        }
        async function fetchAndDrawZones() {
            const response = await fetch('/api/safety_zones');
            const data = await response.json();
            data.safety_zones.forEach(z => L.circle([z.latitude, z.longitude], { color: getZoneColor(z.regional_score), fillColor: getZoneColor(z.regional_score), fillOpacity: 0.2, radius: z.radius * 1000 }).addTo(userMap).bindPopup(`<b>${z.name}</b><br>Score: ${z.regional_score}`));
        }
        function getZoneColor(s) { if (s > 80) return 'green'; if (s > 60) return 'blue'; if (s > 30) return 'orange'; return 'red'; }
        async function sendLocationUpdate() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords, latLng = [lat, lon];
                if (userMap) {
                    userMap.setView(latLng, 13);
                    if (!userMarker) userMarker = L.marker(latLng).addTo(userMap).bindPopup("Your location");
                    else userMarker.setLatLng(latLng);
                }
                const gpsStatus = document.getElementById('gps-status');
                gpsStatus.textContent = `GPS Active | Last update: ${new Date().toLocaleTimeString()}`;
                gpsStatus.classList.remove('animate-pulse', 'text-yellow-400');
                gpsStatus.classList.add('text-green-400');
                try {
                    await fetch('/api/update_location', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ latitude: lat, longitude: lon }) });
                } catch (err) {
                    console.error("Failed to sync location:", err);
                    gpsStatus.textContent = 'Error: Could not sync location.';
                    gpsStatus.classList.add('text-red-500');
                }
            }, () => {
                const gpsStatus = document.getElementById('gps-status');
                gpsStatus.textContent = 'Error: GPS permission denied.';
                gpsStatus.classList.remove('animate-pulse', 'text-yellow-400');
                gpsStatus.classList.add('text-red-500');
            });
        }
        
        // --- UPDATED PANIC BUTTON LOGIC ---
        document.getElementById('panic-button').addEventListener('click', async () => {
            if (confirm("Are you sure you want to send a PANIC alert? This will immediately notify authorities.")) {
                try {
                    const response = await fetch('/api/panic', { method: 'POST' });
                    if (response.ok) {
                        alert("Panic alert has been sent to the authorities.");
                    } else {
                        alert("Failed to send panic alert. Please try again.");
                    }
                } catch (error) {
                    console.error("Error sending panic alert:", error);
                    alert("A network error occurred. Failed to send panic alert.");
                }
            }
        });

        window.onload = () => {
            initUserMap();
            sendLocationUpdate();
            setInterval(sendLocationUpdate, 15000);
        };
    </script>
</body>
</html>